### F. Random Segment Tree

首先访问节点数量上限为 $4 \lceil \log_2 n \rceil$，记为 $m$。

首先这个随机翻转并不会改变每种长度的节点数量和深度。考虑枚举区间询问是在哪个节点 $u$ 处分岔的（除非这个询问正好就是某个区间），这样访问到的节点数量就是 $dep_u$ 加上左右两边子树的访问数量。

发现上述的值**均与节点的位置无关，而只与长度有关**。所以我们只需要对每种长度统计即可。

记 $v_{t,i}$ 表示长为 $t$ 的区间在深度为 $i$ 出现的次数，按 $t$ 从大到小直接转移即可。

$f_{t,i}$ 表示长为 $t$ 的区间，在其中选择左端点使得经过节点为 $i$ 的方案数。由于对称，选择右端点的方案数也是一样的。转移为：

$$W_t(x)=\dfrac{1}{2} [F_{\lfloor t/2 \rfloor}(x)+F_{\lceil t/2 \rceil}(x)]$$

$$F_t(x) = x+W_t(x) x+ (W_t(x)-x) x^2$$

其中第一项对应左端点为 $l$；第二项对应在右子树中选；第三项对应在左子树中选（但不能选 $l$）。

统计答案时，这个区间对答案的贡献为：

$$V(x)[F(x)^2-x^2+1]$$

其中 $-x^2+1$ 是为了修正左端点取 $l$，右端点取 $r$ 的情况。

注意到只有最后才需要求出多项式，直接插值 $0,1,2,\cdots,m$，过程中始终维护点值，最后再还原即可。

注意到所有区间长度只有至多 $2 \log_2 n$ 种（即所有 $\lfloor \frac{n}{2^k} \rfloor$ 和 $\lfloor \frac{n}{2^k} \rfloor + 1$）。总时间复杂度 $O(\log^2 n)$。
