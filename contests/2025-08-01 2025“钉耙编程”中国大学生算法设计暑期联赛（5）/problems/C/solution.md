### C. 黑白球

先考虑原问题。为了方便考虑，下面认为染色时是将 $y$ 的颜色改为 $x$ 的颜色，输入时将 $\{a_i\}$ 倒过来。

显然操作完成后每个位置的黑球数量至多变化 $1$，故下面对每个位置 $i$ 的变化数之和求期望 $s$，最后总黑球数量的期望即为 $s + \sum_{i=1}^n a_i$。

分析 $\{p_i\}$ 的影响，容易发现对 $\{p_i\}$ 的极长上升段 $[l,r]$，等于对于 $[l,r+1]$ 的位置依次进行了 $l \to l+1, l+1 \to l+2, \cdots, r \to r+1$，并且这些段之间是相互独立的。

一个想法是计算 $i$ 位置的期望，枚举其起点为 $j$（$j \leq i$）。但是这样要求 $s_i$ 的话只能通过矩阵描述，很难继续往后做。

另一个做法是直接对更基本的单位——每个球来统计期望。由于所有球都是互相区分的，考虑所有染色关系连边后会形成若干条链。**我们在每条链的链头统计整条链的贡献，而链的后面不统计**。这样的好处是：每个位置都会被随机选择一个点进来（除非 $i=1$），一个点出去（除非 $i=n$），这样就不再需要考虑其它位置的选择。

- $i=1$ 时，随机选择一个点出去。如果选到白点，不会有变化；如果选到黑点，则枚举链长 $l+1$，$l-1$ 个连接点都需要接上，且需要有 $p_1 < p_2 < \cdots < p_l$，于是：

$$s_1 = \dfrac{a_1}{m} \sum\limits_{l=1}^{n-1} \dfrac{1}{m^{l-1}} \dfrac{1}{l!}$$

- $i=n$ 时，随机选择一个点进来。如果选到白点则没有变化，否则减一。

$$s_n = -\dfrac{a_n}{m}$$

- $1 < i < n$ 时，首先最后一定会选择一个点进来，故有 $-\dfrac{a_i}{m}$ 的贡献；对出去的情况分情况讨论：

    - $p_{i-1} > p_i$，则这个出去的点一定作为链头。这次限制条件变为 $p_{i-1} > p_i < p_{i+1} < \cdots < p_{i+l-1}$，可以看作 $l+1$ 个数里选一个非最小的数作为 $p_{i-1}$，于是贡献为：
    
    $$\dfrac{a_i}{m} \sum\limits_{l=1}^{n-i} \dfrac{1}{m^{l-1}} \dfrac{l}{(l+1)!}$$

    - $p_{i-1} < p_i$，若选择进来的点是白点，那出去的点选任意一个黑点均可；若进来的是黑点，则还剩 $(a_i-1)$ 个黑点可选。于是贡献为：
    
    $$(\dfrac{m-a_i}{m} \cdot \dfrac{a_i}{m} + \dfrac{a_i}{m} \cdot \dfrac{a_i-1}{m}) \sum\limits_{l=1}^{n-i} \dfrac{1}{m^{l-1}} \dfrac{1}{(l+1)!} = \dfrac{(m-1)a_i}{m^2} \sum\limits_{l=1}^{n-i} \dfrac{1}{m^{l-1}} \dfrac{1}{(l+1)!}$$

    综合起来，
    
    $$s_i = \dfrac{a_i}{m} \sum\limits_{l=1}^{n-i} \dfrac{1}{m^{l-1}} \dfrac{l}{(l+1)!} + \dfrac{(m-1)a_i}{m^2} \sum\limits_{l=1}^{n-i} \dfrac{1}{m^{l-1}} \dfrac{1}{(l+1)!} - \dfrac{a_i}{m}$$

---

容易发现 $s_i$ 与 $a_i$ 呈线性关系，并且系数容易直接前缀和处理。于是接下来第二问就变成了另一个问题：

- 每次交换序列中相邻两个元素，设交换 $t$ 次后位置 $i$ 上的数所有情况下之和为 $f_{t,i}$，求 $\sum_{i=1}^n c_i f_{t,i}$。

如果是在环上，令初始时 $F_0(x) = \sum_{i=0}^{n-1} a_{i+1} x^i$，那么每次操作就是在循环卷积下乘上 $(x+x^{-1}+n-3)$。但是序列上 $1, n$ 这两个位置的限制很棘手。

一个神奇的 trick：把整个序列复制一遍并翻转，然后拼到后面。即：令 $f_{t,2n-1-i} = f_{t,i}$，整个长为 $2n$ 的序列是 $[f_0,f_1,\cdots,f_{n-1},f_{n-1},\cdots,f_0]$。这时候再做循环卷积就是正确的了，因为 $f_{n-1}$ 会由 $f_n$ 贡献而来，而 $f_n = f_{n-1}$，可以认为它恰好被自己转移；$f_0$ 也是同理。即：

$$F_k(x) = F_0(x) (x+x^{-1}+n-3)^k \bmod (x^{2n}-1)$$

问题即对每个 $k \in [0, K)$ 求：

$$Ans_k = [x^0] C(x) F_k(x) \bmod (x^{2n}-1) = [x^0] C(x) F_0(x) (x+x^{-1}+n-3)^k \bmod (x^{2n}-1)$$

#### Solution 1

记 $A(x) = C(x) F_0(x) \bmod (x^{2n}-1)$，即求：

$$Ans_k = [x^0] A(x) (x+x^{-1}+n-3)^k$$

直接按 [Gym102978D Do Use FFT](https://codeforces.com/gym/102978/problem/D) 做分治 FFT。时间复杂度 $O(n \log^2 n)$ 带大常数，而且看起来相当不好写。

#### Solution 2

题目保证了 $n$ 是 $2$ 的幂，所以可以代单位根。

直接一遍 NTT 求出 $C(x), F_0(x), (x+x^{-1}+n-3)$ 在每个 $\omega_{2n}^t$ 处的点值 $p_t, q_t, r_t$，答案即：

$$Ans_k = \dfrac{1}{2n} \sum\limits_{t=0}^{2n-1} p_t q_t r_t^k$$

这是经典 $k$ 次幂和，

$$ANS(x) = \dfrac{1}{2n} \sum\limits_k x^k \sum\limits_{t=0}^{2n-1} p_t q_t r_t^k = \dfrac{1}{2n} \sum\limits_{t=0}^{2n-1} \dfrac{p_tq_t}{1-r_t x}$$

用分治乘计算一次分式之和，时间复杂度 $O(n \log^2 n)$。分治时还需要特殊处理 $2^k$ 次式乘 $2^k$ 次式，不然常数翻倍。

#### Solution 3

下面多项式运算均在模 $x^{2n}-1$ 次下进行。

$$
\begin{aligned}
S_k &= [x^0] A(x) (x+x^{-1}+n-3)^k \\
&= [x^0] A(x) \sum\limits_{t=0}^k \dbinom{k}{t} (x+x^{-1})^t (n-3)^{k-t} \\
&= \sum\limits_{t=0}^k \dbinom{k}{t} (n-3)^{k-t} [x^0] A(x) (x+x^{-1})^t \\
&= \sum\limits_{t=0}^k \dbinom{k}{t} (n-3)^{k-t} g_t \\
\end{aligned}
$$

于是只需要计算 $g_k = [x^0] A(x) (x+x^{-1})^k$。

如果 $k$ 是偶数，我们可以利用 $(x+x^{-1})^2=x^2+x^{-2}+2$，这样需要利用的项数也会减半。

$$g_{2d} = [x^0] A(x) (x^2+x^{-2}+2)^{d} = \sum\limits_{i=0}^d \dbinom{d}{i} 2^{d-i} [x^0] A(x) (x^2+x^{-2})^{i}$$

而后面那段即提取 $a_0, a_2, \cdots, a_{n-2}$，递归下去的子问题。

对于 $k$ 是奇数，同样：

$$g_{2d+1} = [x^0] (x+x^{-1}) A(x) (x^2+x^{-2}+2)^{d} = \sum\limits_{i=0}^d \dbinom{d}{i} 2^{d-i} [x^0] \Big[ (x+x^{-1}) A(x) \Big] (x^2+x^{-2})^{i}$$

即提取 $(a_{n-1}+a_1)/2, (a_1+a_3)/2, \cdots, (a_{n-3}+a_{n-1})/2$，递归下去的子问题。

于是一个规模为 $2^m$ 的问题可以递归为两个规模为 $2^{m-1}$ 的问题，再通过两次 NTT 合并。时间复杂度为 $O(n) = 2O(n/2) + O(n \log n) = O(n \log^2 n)$。

~~这个做法理论上比 Solution 2 常数小，但不知道为什么还是没有跑过 std~~